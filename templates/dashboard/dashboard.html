{% extends "base.html" %}

{% block title %}ESG Risk Dashboard{% endblock %}

{% block sidebar %}
<aside class="sidebar">
    <h2>Recent companies</h2>
    {% if recent_searches %}
        <ul>
            {% for item in recent_searches %}
                <li>
                    <a href="?company={{ item.company_name|urlencode }}">{{ item.company_name }}</a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No searches yet. Try fetching a company.</p>
    {% endif %}
</aside>
{% endblock %}

{% block content %}
<section class="card">
    <form method="post">
        {% csrf_token %}
        {{ form.company_name }}
        <button type="submit" class="btn" style="margin-top: 1rem;">Fetch ESG Profile</button>
    </form>
</section>

{% if result %}
    <section class="card">
        <header style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h1 style="margin:0;">{{ result.company|title }}</h1>
                <p style="margin:0.25rem 0 0; color: var(--text-secondary);">
                    Generated {{ result.generated_at }}
                    {% if from_cache %}
                        &mdash; served from cache
                    {% endif %}
                </p>
            </div>
            <div>
                <span class="score-badge" style="font-size:1.2rem; padding:0.4rem 0.9rem;">{{ result.overall_score }}</span>
                <div style="font-size:0.85rem; color:var(--text-secondary); text-align:center;">Overall ESG score</div>
            </div>
        </header>
        <article style="margin-top:1rem;">
            <h3 style="margin-top:0;">Company overview</h3>
            <p style="line-height:1.6;">{{ result.overview }}</p>
        </article>
    </section>

    <section class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h2 style="margin:0;">Risk items ({{ result.total_items }})</h2>
            <div style="display:flex; gap:0.5rem; align-items:center;">
                <label for="sortBy" style="font-size:0.9rem; color:var(--text-secondary);">Sort by:</label>
                <select id="sortBy" class="form-control" style="width:auto; padding:0.5rem;">
                    <option value="overall">Overall ESG Score</option>
                    <option value="date">Date</option>
                    <option value="environment">Environment Score</option>
                    <option value="social">Social Score</option>
                    <option value="governance">Governance Score</option>
                </select>
            </div>
        </div>
        {% if result.items %}
            <div style="overflow-x:auto;">
                <table id="riskTable">
                    <thead>
                    <tr>
                        <th style="width:24%;">Title</th>
                        <th>Description</th>
                        <th style="width:12%;">Date</th>
                        <th style="width:12%;">Source</th>
                        <th style="width:16%;">Scores (E / S / G / Overall)</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for item in result.items %}
                        <tr>
                            <td><a href="{{ item.url }}" target="_blank" rel="noopener noreferrer">{{ item.title }}</a></td>
                            <td>{{ item.description }}</td>
                            <td>{{ item.display_date }}</td>
                            <td>{{ item.source }}</td>
                            <td>
                                <span class="score-badge" data-env="{{ item.scores.environment }}">{{ item.scores.environment }}</span>
                                <span class="score-badge" data-soc="{{ item.scores.social }}">{{ item.scores.social }}</span>
                                <span class="score-badge" data-gov="{{ item.scores.governance }}">{{ item.scores.governance }}</span>
                                <span class="score-badge" data-overall="{{ item.scores.overall }}" style="background:#e0ffe4; color:#0b8043;">{{ item.scores.overall }}</span>
                            </td>
                            <td style="display:none;" data-date="{{ item.date }}"></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <script>
                (function() {
                    const sortSelect = document.getElementById('sortBy');
                    const table = document.getElementById('riskTable');
                    const tbody = table.querySelector('tbody');

                    sortSelect.addEventListener('change', function() {
                        const sortBy = this.value;
                        const rows = Array.from(tbody.querySelectorAll('tr'));

                        rows.sort((a, b) => {
                            let valA, valB;

                            if (sortBy === 'date') {
                                const dateA = a.querySelector('[data-date]').getAttribute('data-date') || '';
                                const dateB = b.querySelector('[data-date]').getAttribute('data-date') || '';
                                return dateB.localeCompare(dateA);
                            } else if (sortBy === 'overall') {
                                valA = parseFloat(a.querySelector('[data-overall]').getAttribute('data-overall')) || 0;
                                valB = parseFloat(b.querySelector('[data-overall]').getAttribute('data-overall')) || 0;
                            } else if (sortBy === 'environment') {
                                valA = parseFloat(a.querySelector('[data-env]').getAttribute('data-env')) || 0;
                                valB = parseFloat(b.querySelector('[data-env]').getAttribute('data-env')) || 0;
                            } else if (sortBy === 'social') {
                                valA = parseFloat(a.querySelector('[data-soc]').getAttribute('data-soc')) || 0;
                                valB = parseFloat(b.querySelector('[data-soc]').getAttribute('data-soc')) || 0;
                            } else if (sortBy === 'governance') {
                                valA = parseFloat(a.querySelector('[data-gov]').getAttribute('data-gov')) || 0;
                                valB = parseFloat(b.querySelector('[data-gov]').getAttribute('data-gov')) || 0;
                            }

                            return valB - valA;
                        });

                        rows.forEach(row => tbody.appendChild(row));
                    });
                })();
            </script>
        {% else %}
            <p>No ESG-specific news items found across the last {{ result.search_window_days }} days (â‰ˆ2 years).</p>
        {% endif %}
    </section>
{% endif %}
{% endblock %}

